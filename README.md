# Пример интеграции NASM и Qt

Данный проект является небольшим примером использования NASM (процедур,
написанных на языке ассемблера) совместно с фреймворком Qt. В качестве
приложения с графическим интерфейсом написана простейшая программа, которая
позволяет сложить два действительных числа с помощью математического
сопроцессора.

Предлагаются два варианта использования NASM и Qt: с помощью системы сборки
CMake и с помощью системы сборки QMake. Оба варианта доступны и под Windows,
и под Linux (с некоторыми замечаниями). Так как в Windows и Linux используются
разные соглашения о вызове (и разные регистры для передачи параметров в
функцию), файл с asm-кодом продублирован для Windows и для Linux. Скрипты
сборки составлены так, чтобы автоматически использовать файл для текущей
платформы.
 
## CMake

Предполагается, что вы уже знаете, как использовать CMake с Qt, произвели
необходимые действия для настройки сборки, установили корректный
`CMAKE_PREFIX_PATH` в CMake-скрипте.

Для сборки проекта под Windows рекомендуется использовать компилятор MinGW из
состава Qt. Необходимо также убедиться, что папка с исполняемым файлом NASM
(по умолчанию `C:\Program Files\NASM`) добавлена в `Path`.

Для сборки проекта под Linux рекомендуется использовать компилятор gcc. Сам
процесс сборки под Linux устроен чуть сложнее, чем под Windows (хотя это может
быть не заметно, так как все происходит автоматически). Перед сборкой
запускается скрипт `fix_asm_nasm_flags.sh`. Данный скрипт редактирует
переменную `ASM_NASM_FLAGS` в Makefile, сгенерированном CMake, удаляя из нее
флаг `-fPIC`. Данный флаг автоматически выставляется CMake-скриптами из состава
Qt, а использовать его таким образом с NASM нельзя из-за синтаксиса флагов
NASM (он считает, что флаг, который начинается с `-f`, должен задавать выходной
формат).

Сам по себе скрипт достаточно простой, для удаления флага из соответствующих
Makefile в директориях `cmake-build-release` и `cmake-build-debug` используется
утилита `sed`. Возможно, после клонирования репозитория вам нужно будет выдать
скрипту соответствующие права (`chmod +rwx ./fix_asm_nasm_flags.sh`). Если
вы перенастраиваете CMake для своего проекта, изменяя структуру его папок,
нужно соответствующим образом отредактировать и скрипт.
 
## QMake

Под Windows, как и в случае CMake, необходимо убедиться, что папка с
исполняемым файлом NASM (по умолчанию `C:\Program Files\NASM`) добавлена
в `Path`.

Под Linux дополнительных замечаний нет.

## Плагины CLion и Qt Creator

По умолчанию синтаксис NASM не будет распознаваться и подсвечиваться ни в
CLion, ни в Qt Creator. В CLion рекомендуется установить плагин
[NASM Assembly Language](https://plugins.jetbrains.com/plugin/9759-nasm-assembly-language),
Qt Creator сам предложит установить компоненты для подсветки кода, когда вы
откроете asm-файл.
